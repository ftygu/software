<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>OpenAI å¤šåŠŸèƒ½æ¼”ç¤º</title>
<style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:0 10px;}
    h2{color:#333;}
    .card{background:#fff;border-radius:8px;padding:16px;margin:20px auto;max-width:800px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
    button{padding:6px 12px;border:1px solid #3085d6;background:#409eff;color:#fff;border-radius:4px;cursor:pointer;}
    button:disabled{background:#ccc;border-color:#999;}
    textarea,input[type=text],input[type=number]{width:100%;box-sizing:border-box;margin:6px 0 12px;padding:6px;border:1px solid #ccc;border-radius:4px;}
    #chatbox{height:250px;overflow-y:auto;border:1px solid #ddd;padding:8px;background:#fafafa;}
    .msg{margin:4px 0;}
    .user{color:#1a73e8;}
    .assistant{color:#222;}
    .hidden{display:none;}
    #apiKeyModal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;}
    #apiKeyModal .card{max-width:400px;}
</style>
</head>
<body>

<!-- 1. å›¾ç‰‡è¯†åˆ« -->
<div class="card">
    <h2>1ï¸âƒ£ å›¾ç‰‡è¯†åˆ« (GPT-4o Vision)</h2>
    <input id="imgInput" type="file" accept="image/*">
    <button id="imgBtn" disabled>ä¸Šä¼ å¹¶è¯†åˆ«</button>
    <p id="imgResult"></p>
</div>

<!-- 2. é±¼ç±»ä½“é•¿é¢„æµ‹ -->
<div class="card">
    <h2>2ï¸âƒ£ é±¼ç±»ä½“é•¿é¢„æµ‹</h2>
    <label>é±¼ç§ï¼ˆä¸­æ–‡æˆ–å­¦åï¼‰</label>
    <input id="fishSpecies" type="text" placeholder="ä¾‹å¦‚ï¼šé²¤é±¼ / Cyprinus carpio">
    <label>é‡é‡ (å…‹)</label>
    <input id="fishWeight" type="number" placeholder="ä¾‹å¦‚ï¼š500">
    <button id="fishBtn" disabled>é¢„æµ‹ä½“é•¿</button>
    <p id="fishResult"></p>
</div>

<!-- 3. æ™ºèƒ½é—®ç­” -->
<div class="card">
    <h2>3ï¸âƒ£ æ™ºèƒ½é—®ç­”èŠå¤©</h2>
    <div id="chatbox"></div>
    <textarea id="chatInput" rows="2" placeholder="å‘ GPT æé—®..."></textarea>
    <button id="chatBtn" disabled>å‘é€</button>
</div>

<!-- API-Key å¼¹çª— -->
<div id="apiKeyModal">
    <div class="card">
        <h3>è¯·è¾“å…¥ OpenAI API Key</h3>
        <input id="apiKeyField" type="text" placeholder="sk-...">
        <button id="saveKeyBtn">ä¿å­˜</button>
    </div>
</div>

<script>
let OPENAI_API_KEY = "";

/* ---------- é€šç”¨è¯·æ±‚å‡½æ•° ---------- */
async function callOpenAI(messages, model="gpt-4o-mini", temperature=0.2) {
    const resp = await fetch("https://api.openai-proxy.org/v1/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${OPENAI_API_KEY}`
        },
        body: JSON.stringify({
            model,
            messages,
            temperature
        })
    });
    if(!resp.ok){
        throw new Error(`OpenAI error: ${resp.status} ${await resp.text()}`);
    }
    const data = await resp.json();
    return data.choices[0].message.content.trim();
}

/* ---------- 1. å›¾ç‰‡è¯†åˆ« ---------- */
const imgInput = document.getElementById("imgInput");
const imgBtn = document.getElementById("imgBtn");
const imgResult = document.getElementById("imgResult");

imgInput.addEventListener("change", ()=>{ imgBtn.disabled = !imgInput.files[0]; });

imgBtn.addEventListener("click", async ()=>{
    const file = imgInput.files[0];
    if(!file) return;
    imgBtn.disabled = true; imgResult.textContent = "åˆ†æä¸­...";
    const b64 = await fileToBase64(file);
    const messages = [
        {role:"system",content:"ä½ æ˜¯ä¸€åé±¼ç±»å›¾åƒåˆ†æåŠ©æ‰‹ï¼Œè¯·ç”¨ä¸­æ–‡ç®€æ´æè¿°è¿™å¼ å›¾ç‰‡ä¸­é±¼çš„å“ç§ã€‚"},
        {role:"user",content:[
            {"type":"image_url","image_url":{"url":b64}},
            {"type":"text","text":"è¯·è¯†åˆ«å¹¶æè¿°å›¾ç‰‡å†…å®¹ã€‚"}
        ]}
    ];
    try{
        const answer = await callOpenAI(messages);
        imgResult.textContent = "è¯†åˆ«ç»“æœï¼š " + answer;
    }catch(e){
        imgResult.textContent = e.message;
    }finally{
        imgBtn.disabled = false;
    }
});

function fileToBase64(file){
    return new Promise((res,rej)=>{
        const reader = new FileReader();
        reader.onload = ()=> res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file); // ä¼šå¾—åˆ° data:image/xxx;base64,...
    });
}

/* ---------- 2. é±¼ç±»ä½“é•¿é¢„æµ‹ ---------- */
const fishSpecies = document.getElementById("fishSpecies");
const fishWeight  = document.getElementById("fishWeight");
const fishBtn     = document.getElementById("fishBtn");
const fishResult  = document.getElementById("fishResult");

function validateFish(){ fishBtn.disabled = !(fishSpecies.value && fishWeight.value); }
fishSpecies.addEventListener("input", validateFish);
fishWeight .addEventListener("input", validateFish);

fishBtn.addEventListener("click", async ()=>{
    fishBtn.disabled = true; fishResult.textContent = "é¢„æµ‹ä¸­...";
    const messages = [
        {role:"system",content:`ä½ æ˜¯ä¸€åæ¸”ä¸šç§‘å­¦å®¶ã€‚\
å·²çŸ¥é±¼ç±»å¸¸ç”¨çš„é•¿åº¦-é‡é‡å…³ç³» W = a * L^bã€‚\
è‹¥æˆ‘ç»™å‡ºé±¼ç§åç§°ã€é‡é‡(å…‹)ï¼Œè¯·ä¼°ç®—å¸¸ç”¨çš„å…¨é•¿ (æ€»é•¿, TL) å’Œæ ‡å‡†é•¿ (SL)ï¼Œå•ä½å˜ç±³ã€‚\
è¯·åŸºäºå·²çŸ¥æ–‡çŒ®æˆ–å¸¸è§ç»éªŒå‚æ•°ç»™å‡ºå¤§è‡´åŒºé—´ï¼Œç›´æ¥ç»™æˆ‘é¢„æµ‹çš„æ•°æ®å³å¯,ä¸éœ€è¦å¤šä½™å›ç­”ã€‚ç»“æœç”¨ç®€ä½“ä¸­æ–‡ã€‚`},
        {role:"user",content:`é±¼ç§: ${fishSpecies.value}\né‡é‡: ${fishWeight.value} g`}
    ];
    try{
        const answer = await callOpenAI(messages,"gpt-4o-mini");
        fishResult.textContent = answer;
    }catch(e){
        fishResult.textContent = e.message;
    }finally{
        fishBtn.disabled = false;
    }
});

/* ---------- 3. æ™ºèƒ½é—®ç­”èŠå¤© ---------- */
const chatbox   = document.getElementById("chatbox");
const chatInput = document.getElementById("chatInput");
const chatBtn   = document.getElementById("chatBtn");
let chatHistory = [{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„ä¸­æ–‡åŠ©æ‰‹ã€‚"}];

function appendMsg(text,cls){
    const div=document.createElement("div");
    div.className="msg "+cls;
    div.textContent=text;
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
}

chatInput.addEventListener("input",()=>{ chatBtn.disabled = !chatInput.value.trim(); });

chatBtn.addEventListener("click", async ()=>{
    const q = chatInput.value.trim();
    if(!q) return;
    appendMsg("ğŸ§‘â€ğŸ’»: "+q,"user");
    chatHistory.push({role:"user",content:q});
    chatInput.value=""; chatBtn.disabled=true;
    try{
        const a = await callOpenAI(chatHistory,"gpt-4o-mini",0.7);
        appendMsg("ğŸ¤–: "+a,"assistant");
        chatHistory.push({role:"assistant",content:a});
    }catch(e){
        appendMsg("é”™è¯¯: "+e.message,"assistant");
    }
});

/* ---------- API-Key é€»è¾‘ ---------- */
const modal = document.getElementById("apiKeyModal");
document.getElementById("saveKeyBtn").onclick = ()=>{
    const key = document.getElementById("apiKeyField").value.trim();
    if(!key.startsWith("sk-")){ alert("æ— æ•ˆçš„ Key"); return; }
    OPENAI_API_KEY = key;
    modal.style.display="none";
    // æ¿€æ´»æŒ‰é’®
    [imgBtn,fishBtn,chatBtn].forEach(btn=>btn.disabled=false);
};
</script>
</body>
</html>